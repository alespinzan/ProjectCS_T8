using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace FlightLib
{
    public class FlightPlan
    {
        // Atributos
        private string id; // identificador
        private Position initialPosition; // posicion inicial
        private Position currentPosition; // posicion actual
        private Position finalPosition; // posicion final
        private double velocidad;

        // Propiedades (Gets y Sets)
        public string Id { get { return id; } set { id = value; } }
        public Position InitialPosition { get { return initialPosition; } set { initialPosition = value; } }
        public Position CurrentPosition { get { return currentPosition; } set { currentPosition = value; } }
        public Position FinalPosition { get { return finalPosition; } set { finalPosition = value; } }
        public double Velocity { get { return velocidad; } set { velocidad = value; } }

        // Constructores
        public FlightPlan(string id, double cpx, double cpy, double fpx, double fpy, double velocidad)
        {
            this.id = id;
            this.initialPosition = new Position(cpx, cpy);
            this.currentPosition = new Position(cpx, cpy);
            this.finalPosition = new Position(fpx, fpy);
            this.velocidad = velocidad;
        }

        public FlightPlan(string id, Position initialPosition, Position finalPosition, double velocidad)
        {
            this.id = id;
            this.initialPosition = new Position(initialPosition.GetX(), initialPosition.GetY());
            this.currentPosition = new Position(initialPosition.GetX(), initialPosition.GetY());
            this.finalPosition = new Position(finalPosition.GetX(), finalPosition.GetY());
            this.velocidad = velocidad;
        }

        // Metodos
        public void SetVelocidad(double velocidad)
        // setter del atributo velocidad
        { this.velocidad = velocidad; }

        public void Move(double time)
        {
            // Calculamos la distancia recorrida en el tiempo dado
            double distancia = time * this.velocidad / 60;
            // Calculamos la distancia restante al destino
            double distanciaRestante = currentPosition.Distancia(finalPosition);
            if (distancia >= distanciaRestante)
            {
                currentPosition = new Position(finalPosition.GetX(), finalPosition.GetY());
                return;
            }
            // Calculamos las razones trigonométricas
            double hipotenusa = distanciaRestante;
            double coseno = (finalPosition.GetX() - currentPosition.GetX()) / hipotenusa;
            double seno = (finalPosition.GetY() - currentPosition.GetY()) / hipotenusa;
            // Calculamos la nueva posición del vuelo
            double x = currentPosition.GetX() + distancia * coseno;
            double y = currentPosition.GetY() + distancia * seno;
            currentPosition = new Position(x, y);
        }

        public bool HasArrived()
        {
            // Considera que ha llegado si la distancia es muy pequeña (tolerancia)
            return currentPosition.Distancia(finalPosition) < 1e-6;
        }

        public void Restart()
        {
            currentPosition = new Position(initialPosition.GetX(), initialPosition.GetY());
        }

        public double Distance(FlightPlan plan)
        {
            return this.currentPosition.Distancia(plan.currentPosition);
        }

        // Métodos antiguos para compatibilidad (puedes eliminarlos si no los necesitas)
        public void Mover(double tiempo)
        // Mueve el vuelo a la posición correspondiente a viajar durante el tiempo que se recibe como parámetro
        {
            //Calculamos la distancia recorrida en el tiempo dado
            double distancia = tiempo * this.velocidad / 60;

            //Calculamos las razones trigonométricas
            double hipotenusa = Math.Sqrt((finalPosition.GetX() - currentPosition.GetX()) * (finalPosition.GetX() - currentPosition.GetX()) + (finalPosition.GetY() - currentPosition.GetY()) * (finalPosition.GetY() - currentPosition.GetY()));
            double coseno = (finalPosition.GetX() - currentPosition.GetX()) / hipotenusa;
            double seno = (finalPosition.GetY() - currentPosition.GetY()) / hipotenusa;

            //Caculamos la nueva posición del vuelo
            double x = currentPosition.GetX() + distancia * coseno;
            double y = currentPosition.GetY() + distancia * seno;

            Position nextPosition = new Position(x, y);

            // Modificar MoverVuelo para que no se pase del destino
            if (currentPosition.Distancia(nextPosition) < hipotenusa)
                currentPosition = nextPosition;
            else
                currentPosition = finalPosition;

        }

        // Hacer un metodo que diga si un vuelo ha llegado a su destino
        public bool EstaDestino()
        {
            bool resultado = false;
            if (currentPosition == finalPosition)
                resultado = true;

            return resultado;
        }

        // Hacer que el programa principal lea datos de dos vuelos y una distancia de seguidad y detecte el conflicto cuándo los vuelos están mas cerca de esa distancia
        public bool Conflicto(FlightPlan b, double distanciaSeguridad)
        {
            bool conclicto = false;

            if (this.currentPosition.Distancia(b.currentPosition) < distanciaSeguridad)
                conclicto = true;

            return conclicto;
        }

        public void EscribeConsola()
        // escribe en consola los datos del plan de vuelo
        {
            Console.WriteLine("******************************");
            Console.WriteLine("Datos del vuelo: ");
            Console.WriteLine("Identificador: {0}", id);
            Console.WriteLine("Velocidad: {0:F2}", velocidad);
            Console.WriteLine("Posición actual: ({0:F2}, {1:F2})", currentPosition.GetX(), currentPosition.GetY());
            if (this.HasArrived())
                Console.WriteLine("Ha llegado al destino");
            Console.WriteLine("******************************");
        }
    }
}
